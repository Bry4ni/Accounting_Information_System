{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-4">
  <div class="card mb-3">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div>
        <h4 class="mb-0">Client Management</h4>
        <small class="muted-small">Manage client profiles and view financial summaries</small>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="input-group">
          <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
          <input id="clientSearch" type="text" class="form-control" placeholder="Search clients by name, email, or company...">
          <button id="clearSearch" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
        {% if current_user.role == 'owner' %}
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addClientModal">
          <i class="bi bi-plus-circle me-1"></i> Add Client
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Clients Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
      <table id="clientsTable" class="table table-hover align-middle mb-0">
        <thead class="table-light border-bottom">
          <tr>
            <th>Name</th>
            <th>Company</th>
            <th>Contact</th>
            <th>Invoices</th>
            <th>Total Amount</th>
            <th>Outstanding</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clients %}
          {% set outstanding = (c.total_invoiced or 0) - (c.total_paid or 0) %}
          <tr>
            <td>
              <strong>{{ c.name }}</strong><br>
              <small class="text-muted">{{ c.tax_id or '—' }}</small>
            </td>
            <td>{{ c.company or '-' }}</td>
            <td>
              <div>{{ c.email or '-' }}</div>
              <small class="text-muted">{{ c.phone or '-' }}</small>
            </td>
            <td><span class="badge bg-light text-dark border">{{ c.invoices|length }}</span></td>
            <td>₱{{ '%.2f'|format(c.total_invoiced or 0) }}</td>
            <td>
              {% if outstanding > 0 %}
                <span class="text-danger fw-bold">₱{{ '%.2f'|format(outstanding) }}</span>
              {% else %}
                <span class="text-success">₱0.00</span>
              {% endif %}
            </td>
            <td class="text-center actions-group">
              <div class="d-inline-flex">
                <button class="btn btn-sm btn-outline-secondary me-1 btn-view" data-id="{{ c.id }}" title="View Client"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-primary me-1 btn-edit" data-id="{{ c.id }}" data-name="{{ c.name }}" data-email="{{ c.email }}" data-phone="{{ c.phone }}" data-company="{{ c.company }}" data-tax="{{ c.tax_id }}" data-address="{{ c.address }}" title="Edit Client" data-bs-toggle="modal" data-bs-target="#editClientModal"><i class="bi bi-pencil"></i></button>
                <form method="POST" action="{{ url_for('clients.delete_client', id=c.id) }}" class="d-inline" onsubmit="return confirm('Delete client?')">
                  <button class="btn btn-sm btn-outline-danger me-1" title="Delete Client"><i class="bi bi-trash"></i></button>
                </form>
                {% if current_user.role == 'owner' %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('auth.impersonate_client', client_id=c.id) }}" title="View as client">
                  <i class="bi bi-person-lines-fill"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('clients.add_client') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="addClientModalLabel">Add New Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><input type="text" name="name" class="form-control" placeholder="Full Name" required></div>
            <div class="col-md-6"><input type="email" name="email" class="form-control" placeholder="Email"></div>
            <div class="col-md-6"><input type="text" name="phone" class="form-control" placeholder="Phone"></div>
            <div class="col-md-6"><input type="text" name="company" class="form-control" placeholder="Company"></div>
            <div class="col-md-6"><input type="text" name="tax_id" class="form-control" placeholder="Tax ID"></div>
            <div class="col-12"><textarea name="address" class="form-control" rows="2" placeholder="Address"></textarea></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-dark">Create Client</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="clientModalLabel">
          <i class="bi bi-person-circle me-2"></i>Client Profile
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="fw-bold">Client Information</h6>
            <p><strong>Name:</strong> <span id="clientName">-</span></p>
            <p><strong>Company:</strong> <span id="clientCompany">-</span></p>
            <p><strong>Email:</strong> <span id="clientEmail">-</span></p>
            <p><strong>Phone:</strong> <span id="clientPhone">-</span></p>
            <p><strong>Tax ID:</strong> <span id="clientTax">-</span></p>
            <p><strong>Address:</strong> <span id="clientAddress">-</span></p>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold">Financial Summary</h6>
            <div class="border rounded p-2 mb-2">
              <small>Total Invoiced</small>
              <h6 id="totalInvoiced" class="text-primary mb-0">₱0.00</h6>
            </div>
            <div class="border rounded p-2 mb-2">
              <small>Total Paid</small>
              <h6 id="totalPaid" class="text-success mb-0">₱0.00</h6>
            </div>
            <div class="border rounded p-2 mb-2">
              <small>Outstanding</small>
              <h6 id="outstanding" class="text-danger mb-0">₱0.00</h6>
            </div>
            <div class="border rounded p-2 mb-2">
              <small>Number of Invoices</small>
              <h6 id="invoiceCount" class="mb-0">0</h6>
            </div>
          </div>
        </div>
        <hr>
        <h6 class="fw-bold mb-3">Recent Invoices</h6>
        <div id="recentInvoices">
          <p class="text-muted">No invoices found for this client.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Client Modal (single reusable modal) -->
<div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="editClientForm" method="POST">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="editClientModalLabel"><i class="bi bi-pencil-square me-2"></i>Edit Client</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input type="text" name="name" id="editName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email" id="editEmail" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="text" name="phone" id="editPhone" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Company</label>
              <input type="text" name="company" id="editCompany" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tax ID</label>
              <input type="text" name="tax_id" id="editTax" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea name="address" id="editAddress" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-dark">Update Client</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/search_clients.js') }}?v=6" defer></script>
<script src="{{ url_for('static', filename='js/view_clients.js') }}?v=6" defer></script>
<script src="{{ url_for('static', filename='js/edit_clients.js') }}?v=6" defer></script>

{% endblock %}