{% extends "base.html" %}

{% block title %}Client Portal - Accounting System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900" id="welcome-message">Welcome back</h1>
                    <p class="text-gray-600 mt-1" id="company-name"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Account ID</p>
                        <p class="font-medium text-gray-900" id="tax-id"></p>
                    </div>
                    <a href="{{ url_for('logout') }}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Account Overview Cards -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Account Overview</h2>
            <div class="grid gap-4 md:grid-cols-4">
                <div class="bg-white rounded-lg shadow p-6 card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Total Invoiced</h3>
                        <i class="fas fa-file-invoice text-gray-400"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="total-invoiced">$0</p>
                    <p class="text-sm text-gray-600 mt-1" id="invoice-count">0 invoices</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Paid</h3>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <p class="text-2xl font-bold text-green-600" id="total-paid">$0</p>
                    <p class="text-sm text-gray-600 mt-1" id="payment-count">0 payments</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Outstanding</h3>
                        <i class="fas fa-exclamation-circle text-orange-500"></i>
                    </div>
                    <p class="text-2xl font-bold text-orange-600" id="total-outstanding">$0</p>
                    <p class="text-sm text-gray-600 mt-1">Amount due</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Invoice Status</h3>
                        <i class="fas fa-chart-pie text-blue-500"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="paid-invoices">0 Paid</p>
                    <p class="text-sm text-gray-600 mt-1" id="pending-invoices">0 Pending</p>
                </div>
            </div>
        </div>

        <!-- Active Installment Plans -->
        <div id="installment-section" class="mb-8 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Active Installment Plans</h2>
            <div id="installment-plans" class="grid gap-4 md:grid-cols-2">
                <!-- Installment plans will be rendered here -->
            </div>
        </div>

        <!-- All Invoices -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">All Invoices</h2>
            <div id="all-invoices" class="space-y-3">
                <p class="text-gray-600">Loading invoices...</p>
            </div>
        </div>

        <!-- Payment History -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Payment History</h2>
            <div class="bg-white rounded-lg shadow p-6">
                <div id="payment-history">
                    <p class="text-gray-600">Loading payments...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Invoice Detail Modal -->
<div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900">Invoice Details</h2>
                <button onclick="closeInvoiceModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <p class="text-gray-600 mt-1">Complete information about your invoice and payment schedule</p>
        </div>
        <div class="p-6" id="invoice-detail-content">
            <!-- Invoice details will be rendered here -->
        </div>
    </div>
</div>

<script>
let currentUser = null;
let invoices = [];
let payments = [];

async function loadData() {
    try {
        const [userRes, invoicesRes, paymentsRes] = await Promise.all([
            fetch('/api/current-user'),
            fetch('/api/invoices'),
            fetch('/api/payments')
        ]);
        
        currentUser = await userRes.json();
        invoices = await invoicesRes.json();
        payments = await paymentsRes.json();
        
        renderPortal();
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function renderPortal() {
    // Header
    const firstName = currentUser.name.split(' ')[0];
    document.getElementById('welcome-message').textContent = `Welcome back, ${firstName}`;
    document.getElementById('company-name').textContent = currentUser.company;
    document.getElementById('tax-id').textContent = currentUser.taxId;
    
    // Calculate stats
    const totalInvoiced = invoices.reduce((sum, inv) => sum + inv.amount, 0);
    const totalPaid = payments.reduce((sum, pay) => sum + pay.amount, 0);
    const totalOutstanding = totalInvoiced - totalPaid;
    const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
    const pendingInvoices = invoices.filter(inv => inv.status !== 'paid').length;
    
    document.getElementById('total-invoiced').textContent = '$' + totalInvoiced.toLocaleString();
    document.getElementById('invoice-count').textContent = invoices.length + ' invoices';
    document.getElementById('total-paid').textContent = '$' + totalPaid.toLocaleString();
    document.getElementById('payment-count').textContent = payments.length + ' payments';
    document.getElementById('total-outstanding').textContent = '$' + totalOutstanding.toLocaleString();
    document.getElementById('paid-invoices').textContent = paidInvoices + ' Paid';
    document.getElementById('pending-invoices').textContent = pendingInvoices + ' Pending';
    
    // Installment plans
    const installmentInvoices = invoices.filter(inv => inv.paymentType === 'installment');
    if (installmentInvoices.length > 0) {
        document.getElementById('installment-section').classList.remove('hidden');
        renderInstallmentPlans(installmentInvoices);
    }
    
    // All invoices
    renderAllInvoices();
    
    // Payment history
    renderPaymentHistory();
}

function renderInstallmentPlans(installmentInvoices) {
    const html = installmentInvoices.map(invoice => {
        const invoicePayments = payments.filter(p => p.invoiceId == invoice.id);
        const paid = invoicePayments.reduce((sum, p) => sum + p.amount, 0);
        const remaining = invoice.amount - paid;
        const progress = (paid / invoice.amount) * 100;
        const statusClass = getStatusClass(invoice.status);
        
        return `
            <div class="bg-white rounded-lg shadow overflow-hidden card">
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="font-bold text-gray-900">${invoice.invoiceNumber}</h3>
                            <p class="text-sm text-gray-600 mt-1">${invoice.description}</p>
                        </div>
                        <span class="badge ${statusClass}">${invoice.status}</span>
                    </div>
                </div>
                <div class="p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Progress</p>
                            <p class="font-medium text-gray-900">
                                ${invoicePayments.length} of ${invoice.installmentPlan.totalInstallments} installments
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Next Payment</p>
                            <p class="font-medium text-gray-900">$${invoice.installmentPlan.installmentAmount.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-200">
                        <div>
                            <p class="text-sm text-gray-600">Paid</p>
                            <p class="font-medium text-green-600">$${paid.toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Remaining</p>
                            <p class="font-medium text-orange-600">$${remaining.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <button onclick="viewInvoiceDetails('${invoice.id}')" class="w-full py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        View Details
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('installment-plans').innerHTML = html;
}

function renderAllInvoices() {
    const html = invoices.map(invoice => {
        const invoicePayments = payments.filter(p => p.invoiceId == invoice.id);
        const paid = invoicePayments.reduce((sum, p) => sum + p.amount, 0);
        const remaining = invoice.amount - paid;
        const progress = (paid / invoice.amount) * 100;
        const statusClass = getStatusClass(invoice.status);
        
        return `
            <div class="bg-white rounded-lg shadow p-6 card">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="font-bold text-gray-900">${invoice.invoiceNumber}</h3>
                            <span class="badge ${statusClass}">${invoice.status}</span>
                            ${invoice.paymentType === 'installment' ? '<span class="badge badge-info">Installment Plan</span>' : ''}
                        </div>
                        <p class="text-gray-600">${invoice.description}</p>
                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-calendar"></i>
                                <span>Issued: ${new Date(invoice.issueDate).toLocaleDateString()}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i class="fas fa-clock"></i>
                                <span>Due: ${new Date(invoice.dueDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Total Amount</p>
                        <p class="text-xl font-bold text-gray-900">$${invoice.amount.toLocaleString()}</p>
                    </div>
                </div>
                
                ${invoice.status !== 'paid' ? `
                    <div class="space-y-2 mb-4">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-green-600">$${paid.toLocaleString()} paid</span>
                            <span class="text-orange-600">$${remaining.toLocaleString()} remaining</span>
                        </div>
                    </div>
                ` : ''}
                
                <button onclick="viewInvoiceDetails('${invoice.id}')" class="w-full py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    View Details
                </button>
            </div>
        `;
    }).join('');
    
    document.getElementById('all-invoices').innerHTML = html || '<p class="text-gray-600">No invoices found</p>';
}

function renderPaymentHistory() {
    if (payments.length === 0) {
        document.getElementById('payment-history').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-circle text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-600">No payments recorded yet</p>
            </div>
        `;
        return;
    }
    
    const sortedPayments = [...payments].sort((a, b) => 
        new Date(b.paymentDate) - new Date(a.paymentDate)
    );
    
    const html = sortedPayments.map(payment => {
        const invoice = invoices.find(inv => inv.id == payment.invoiceId);
        
        return `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg mb-2">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">${invoice ? invoice.invoiceNumber : 'Unknown'}</p>
                        <p class="text-sm text-gray-600">
                            ${payment.installmentNumber ? `Installment #${payment.installmentNumber}` : 'Full Payment'} â€¢ ${payment.paymentMethod}
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-medium text-green-600">$${payment.amount.toLocaleString()}</p>
                    <p class="text-sm text-gray-600">${new Date(payment.paymentDate).toLocaleDateString()}</p>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('payment-history').innerHTML = html;
}

function getStatusClass(status) {
    return {
        'paid': 'badge-success',
        'partial': 'badge-info',
        'pending': 'badge-warning',
        'overdue': 'badge-danger'
    }[status] || 'badge-warning';
}

function viewInvoiceDetails(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) return;
    
    const invoicePayments = payments.filter(p => p.invoiceId == invoiceId);
    const paid = invoicePayments.reduce((sum, p) => sum + p.amount, 0);
    const remaining = invoice.amount - paid;
    const statusClass = getStatusClass(invoice.status);
    
    const content = `
        <div class="space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-600">Invoice Number</p>
                    <p class="font-medium text-gray-900">${invoice.invoiceNumber}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Status</p>
                    <span class="badge ${statusClass}">${invoice.status}</span>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Issue Date</p>
                    <p class="font-medium text-gray-900">${new Date(invoice.issueDate).toLocaleDateString()}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Due Date</p>
                    <p class="font-medium text-gray-900">${new Date(invoice.dueDate).toLocaleDateString()}</p>
                </div>
                <div class="col-span-2">
                    <p class="text-sm text-gray-600">Description</p>
                    <p class="font-medium text-gray-900">${invoice.description}</p>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h3 class="font-bold text-gray-900 mb-3">Payment Summary</h3>
                <div class="space-y-2 bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Total Amount</span>
                        <span class="font-medium text-gray-900">$${invoice.amount.toLocaleString()}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Amount Paid</span>
                        <span class="font-medium text-green-600">$${paid.toLocaleString()}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Amount Due</span>
                        <span class="font-medium text-orange-600">$${remaining.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            
            ${invoice.paymentType === 'installment' ? `
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="font-bold text-gray-900 mb-3">Installment Plan</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Total Installments</p>
                            <p class="font-bold text-gray-900">${invoice.installmentPlan.totalInstallments}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Amount per Installment</p>
                            <p class="font-bold text-gray-900">$${invoice.installmentPlan.installmentAmount.toLocaleString()}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Frequency</p>
                            <p class="font-bold text-gray-900 capitalize">${invoice.installmentPlan.frequency}</p>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="border-t border-gray-200 pt-6">
                <h3 class="font-bold text-gray-900 mb-3">Payment History</h3>
                ${invoicePayments.length === 0 ? '<p class="text-gray-600">No payments recorded yet</p>' : `
                    <div class="space-y-2">
                        ${invoicePayments.map(payment => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-900">
                                        ${payment.installmentNumber ? `Installment #${payment.installmentNumber}` : 'Payment'}
                                    </p>
                                    <p class="text-sm text-gray-600">${payment.paymentMethod}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-medium text-green-600">$${payment.amount.toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">${new Date(payment.paymentDate).toLocaleDateString()}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
    document.getElementById('invoice-detail-content').innerHTML = content;
    document.getElementById('invoice-modal').classList.remove('hidden');
    document.getElementById('invoice-modal').classList.add('flex');
}

function closeInvoiceModal() {
    document.getElementById('invoice-modal').classList.add('hidden');
    document.getElementById('invoice-modal').classList.remove('flex');
}

// Load data on page load
loadData();
</script>
{% endblock %}
